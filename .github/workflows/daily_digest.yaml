name: ArXiv Digest Daily

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆåªå¤„ç†1ç¯‡è®ºæ–‡ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©UTCæ—¶é—´09:00ï¼ˆåŒ—äº¬æ—¶é—´17:00ï¼‰æ‰§è¡Œ
  schedule:
#    - cron: '0 9 * * 1-5'  # å‘¨ä¸€åˆ°å‘¨äº”
    - cron: '0 1 * * *'  # å¦‚æœéœ€è¦æ¯å¤©éƒ½æ‰§è¡Œï¼Œå–æ¶ˆæ³¨é‡Šè¿™è¡Œ

jobs:
  generate-digest:
    runs-on: ubuntu-latest

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.11'
        cache: 'pip'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: éªŒè¯ç¯å¢ƒå˜é‡
      run: |
        echo "æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡..."
        if [ -z "$CUSTOM_API_KEY" ]; then
          echo "âŒ CUSTOM_API_KEYæœªè®¾ç½®"
          exit 1
        else
          echo "âœ… CUSTOM_API_KEYå·²è®¾ç½®"
        fi
        
        # æ£€æŸ¥é‚®ä»¶é…ç½®ï¼ˆå¯é€‰ï¼‰
        if [ -n "$SENDGRID_API_KEY" ] && [ -n "$FROM_EMAIL" ] && [ -n "$TO_EMAIL" ]; then
          echo "âœ… SendGridé‚®ä»¶é…ç½®å®Œæ•´"
        elif [ -n "$MAIL_CONNECTION" ] && [ -n "$FROM_EMAIL" ] && [ -n "$TO_EMAIL" ]; then
          echo "âœ… SMTPé‚®ä»¶é…ç½®å®Œæ•´"
        elif [ -n "$MAIL_USERNAME" ] && [ -n "$MAIL_PASSWORD" ] && [ -n "$FROM_EMAIL" ] && [ -n "$TO_EMAIL" ]; then
          echo "âœ… SMTPç”¨æˆ·åå¯†ç é…ç½®å®Œæ•´"
        else
          echo "âš ï¸ é‚®ä»¶é…ç½®ä¸å®Œæ•´ï¼Œå°†åªç”ŸæˆHTMLæ–‡ä»¶"
        fi
        
        # æ˜¾ç¤ºæµ‹è¯•æ¨¡å¼çŠ¶æ€
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ§ª æµ‹è¯•æ¨¡å¼å·²å¯ç”¨ - åªå¤„ç†1ç¯‡è®ºæ–‡"
        else
          echo "ğŸš€ æ­£å¸¸æ¨¡å¼ - å¤„ç†æ‰€æœ‰ç›¸å…³è®ºæ–‡"
        fi
      env:
        CUSTOM_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
        SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        MAIL_CONNECTION: ${{ secrets.MAIL_CONNECTION }}
        MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
        MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
        TO_EMAIL: ${{ secrets.TO_EMAIL }}

    - name: è¿è¡ŒArXiv Digestç”Ÿæˆ
      run: |
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šç”Ÿæˆå•è®ºæ–‡ArXiv Digest..."
          # å¦‚æœå­˜åœ¨æµ‹è¯•é…ç½®æ–‡ä»¶åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤é…ç½®
          if [ -f "test-config.yaml" ]; then
            echo "ğŸ“ ä½¿ç”¨æµ‹è¯•ä¸“ç”¨é…ç½®æ–‡ä»¶: test-config.yaml"
            python src/action.py --config test-config.yaml --test-mode
          else
            echo "ğŸ“ ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶: config.yaml"
            python src/action.py --config config.yaml --test-mode
          fi
        else
          echo "ğŸš€ æ­£å¸¸æ¨¡å¼ï¼šç”Ÿæˆå®Œæ•´ArXiv Digest..."
          python src/action.py --config config.yaml
        fi
      env:
        CUSTOM_API_KEY: ${{ secrets.CUSTOM_API_KEY }}
        SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
        MAIL_CONNECTION: ${{ secrets.MAIL_CONNECTION }}
        MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
        MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
        TO_EMAIL: ${{ secrets.TO_EMAIL }}
        ARXIV_DIGEST_TEST_MODE: ${{ github.event.inputs.test_mode }}

    - name: ä¸Šä¼ HTMLæ‘˜è¦æ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: arxiv-digest-html-${{ github.event.inputs.test_mode == 'true' && 'test' || 'full' }}
        path: digest.html
        retention-days: 30

    - name: ä¸Šä¼ æ•°æ®æ–‡ä»¶
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: arxiv-data-${{ github.event.inputs.test_mode == 'true' && 'test' || 'full' }}
        path: data/
        retention-days: 7

    - name: æ˜¾ç¤ºè¿è¡Œæ€»ç»“
      run: |
        echo "==================== è¿è¡Œæ€»ç»“ ===================="
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ§ª æµ‹è¯•æ¨¡å¼è¿è¡Œç»“æœ:"
        else
          echo "ğŸš€ æ­£å¸¸æ¨¡å¼è¿è¡Œç»“æœ:"
        fi
        
        if [ -f "digest.html" ]; then
          file_size=$(stat -c%s "digest.html")
          echo "âœ… HTMLæ‘˜è¦ç”ŸæˆæˆåŠŸ: ${file_size} bytes"
          
          # æ˜¾ç¤ºHTMLå†…å®¹æ¦‚è¦
          echo "ğŸ“„ æ‘˜è¦å†…å®¹æ¦‚è¦:"
          if command -v grep >/dev/null 2>&1; then
            paper_count=$(grep -c "<h3>" digest.html 2>/dev/null || echo "æ— æ³•ç»Ÿè®¡")
            echo "   è®ºæ–‡æ•°é‡: ${paper_count} ç¯‡"
          fi
        else
          echo "âŒ HTMLæ‘˜è¦ç”Ÿæˆå¤±è´¥"
        fi
        
        echo "ğŸ“ æ•°æ®æ–‡ä»¶:"
        ls -la data/ 2>/dev/null || echo "æ— æ•°æ®æ–‡ä»¶"
        
        if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
          echo "ğŸ“§ æµ‹è¯•æ¨¡å¼å®Œæˆ - è¯·æ£€æŸ¥é‚®ç®±æ˜¯å¦æ”¶åˆ°å•è®ºæ–‡æµ‹è¯•é‚®ä»¶"
        else
          echo "ğŸ“§ æ­£å¸¸æ¨¡å¼å®Œæˆ - è¯·æ£€æŸ¥é‚®ç®±æ˜¯å¦æ”¶åˆ°å®Œæ•´digest"
        fi
        echo "=================================================="